<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COF& Loyalty System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
  </head>
  <body class="bg-gray-50">
    <div id="app"></div>

    <script src="supabase-client.js"></script>
    <script>
      // Configuraci√≥n de colores COF&
      const COLORS = {
        primary: '#3D1E1E',
        secondary: '#F5A623',
        accent: '#7FA650'
      };

      // Estado de la aplicaci√≥n
      let currentView = 'login';
      let isAdmin = false;
      let currentCustomer = null;
      let html5QrCode = null;

      // Renderizar app
      function render() {
        const app = document.getElementById('app');
        
        if (currentView === 'login') {
          app.innerHTML = renderLogin();
        } else if (currentView === 'employee') {
          app.innerHTML = renderEmployee();
        } else if (currentView === 'admin') {
          app.innerHTML = renderAdmin();
        } else if (currentView === 'scanQR') {
          app.innerHTML = renderScanQR();
          setTimeout(startQRScanner, 100);
        } else if (currentView === 'givePunch') {
          app.innerHTML = renderGivePunch();
        } else if (currentView === 'validateReward') {
          app.innerHTML = renderValidateReward();
        }
      }

      // Pantalla de login
      function renderLogin() {
        return `
          <div class="min-h-screen flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full border-4" style="border-color: ${COLORS.primary}">
              <div class="text-center mb-8">
                <div class="w-32 h-32 mx-auto mb-4">
                  <img src="logo.png" alt="COF& Logo" class="w-full h-full object-contain">
                </div>
                <h1 class="text-3xl font-bold mb-2" style="color: ${COLORS.primary}">COF& Loyalty</h1>
                <p class="text-gray-600">Admin System</p>
              </div>
              
              <button onclick="loginEmployee()" class="w-full py-4 rounded-xl font-semibold text-white mb-4 hover:opacity-90 transition" style="background-color: ${COLORS.secondary}">
                üì∑ Start as Employee
              </button>
              
              <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">or</span></div>
              </div>
              
              <input type="password" id="adminPassword" placeholder="Administrator Password" class="w-full px-4 py-3 border-2 rounded-xl mb-4 focus:outline-none" style="border-color: ${COLORS.primary}" onkeypress="if(event.key==='Enter') loginAdmin()">
              <button onclick="loginAdmin()" class="w-full py-4 rounded-xl font-semibold text-white hover:opacity-90 transition" style="background-color: ${COLORS.primary}">
                ‚öôÔ∏è Login as Administrator
              </button>
            </div>
          </div>
        `;
      }

      // Dashboard de empleado
      function renderEmployee() {
        return `
          <div class="min-h-screen p-6" style="background: linear-gradient(135deg, ${COLORS.primary} 0%, ${COLORS.secondary} 100%)">
            <div class="max-w-md mx-auto">
              <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-2xl font-bold" style="color: ${COLORS.primary}">Employee Mode</h2>
                  <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                    ‚Üê Logout
                  </button>
                </div>
              </div>

              <div class="space-y-4">
                <button onclick="currentView='scanQR'; render();" class="w-full bg-white rounded-2xl shadow-xl p-8 text-left hover:shadow-2xl transition">
                  <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: ${COLORS.secondary}20">
                      <span class="text-3xl">üì∑</span>
                    </div>
                    <div>
                      <h3 class="text-xl font-bold" style="color: ${COLORS.primary}">Scan Customer QR</h3>
                      <p class="text-gray-600 text-sm">Give a punch or validate reward</p>
                    </div>
                  </div>
                </button>

                <button onclick="viewCustomers()" class="w-full bg-white rounded-2xl shadow-xl p-8 text-left hover:shadow-2xl transition">
                  <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: ${COLORS.accent}20">
                      <span class="text-3xl">üë•</span>
                    </div>
                    <div>
                      <h3 class="text-xl font-bold" style="color: ${COLORS.primary}">View Customers</h3>
                      <p class="text-gray-600 text-sm">See all registered customers</p>
                    </div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // Pantalla de escaneo QR
      function renderScanQR() {
        return `
          <div class="min-h-screen p-6" style="background-color: ${COLORS.primary}">
            <div class="max-w-md mx-auto">
              <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-2xl font-bold" style="color: ${COLORS.primary}">Scan QR Code</h2>
                  <button onclick="stopQRScanner(); currentView='employee'; render();" class="text-gray-500 hover:text-gray-700">
                    ‚úï Close
                  </button>
                </div>
                <p class="text-gray-600 text-sm">Point camera at customer's QR code</p>
              </div>

              <div class="bg-white rounded-2xl shadow-xl p-4 mb-4">
                <div id="qr-reader" class="w-full"></div>
              </div>

              <div class="bg-white rounded-2xl shadow-xl p-6">
                <p class="text-center text-gray-600 text-sm">
                  üì± Make sure to allow camera access
                </p>
              </div>
            </div>
          </div>
        `;
      }

      // Pantalla para dar punch
      function renderGivePunch() {
        const c = currentCustomer;
        if (!c) return '';

        const filledPunches = '‚òï'.repeat(c.punches);
        const emptyPunches = '‚ö™'.repeat(10 - c.punches);
        
        return `
          <div class="min-h-screen p-6" style="background: linear-gradient(135deg, ${COLORS.accent} 0%, ${COLORS.secondary} 100%)">
            <div class="max-w-md mx-auto">
              <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                <div class="text-center mb-6">
                  <div class="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center" style="background-color: ${COLORS.secondary}20">
                    <span class="text-4xl">üë§</span>
                  </div>
                  <h2 class="text-2xl font-bold mb-1" style="color: ${COLORS.primary}">${c.name}</h2>
                  <p class="text-gray-600">${c.phone}</p>
                  <p class="text-gray-500 text-sm">${c.email}</p>
                </div>

                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                  <p class="text-sm font-semibold mb-3" style="color: ${COLORS.primary}">Current Progress</p>
                  <div class="text-3xl mb-3 text-center">${filledPunches}${emptyPunches}</div>
                  <div class="flex justify-between text-lg font-bold" style="color: ${COLORS.secondary}">
                    <span>${c.punches} / 10 punches</span>
                    ${c.punches === 9 ? '<span class="text-red-500">üéÅ Next = FREE!</span>' : ''}
                  </div>
                </div>

                <button onclick="givePunch()" class="w-full text-white py-4 rounded-xl font-bold text-lg shadow-lg mb-3" style="background-color: ${COLORS.secondary}">
                  ‚òï Give 1 Punch
                </button>
                
                <button onclick="currentView='employee'; currentCustomer=null; render();" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // Pantalla para validar premio
      function renderValidateReward() {
        const c = currentCustomer;
        if (!c || !c.reward_code) return '';

        return `
          <div class="min-h-screen p-6" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%)">
            <div class="max-w-md mx-auto">
              <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-6">
                  <div class="text-6xl mb-4">üéâ</div>
                  <h2 class="text-3xl font-bold mb-2" style="color: ${COLORS.primary}">Reward Ready!</h2>
                  <p class="text-xl font-semibold mb-1">${c.name}</p>
                  <p class="text-gray-600">${c.phone}</p>
                </div>

                <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-8 mb-6 text-white text-center">
                  <p class="text-sm mb-2 opacity-90">Free Drink Code:</p>
                  <p class="text-4xl font-bold tracking-wider mb-2">${c.reward_code}</p>
                  <p class="text-xs opacity-75">Use this code in TOAST POS</p>
                </div>

                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                  <p class="text-sm font-semibold text-yellow-800 mb-2">üìã Instructions:</p>
                  <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                    <li>Open TOAST POS</li>
                    <li>Add free drink item</li>
                    <li>Apply discount code: <strong>${c.reward_code}</strong></li>
                    <li>Confirm redemption below</li>
                  </ol>
                </div>

                <button onclick="confirmRedemption()" class="w-full text-white py-4 rounded-xl font-bold text-lg shadow-lg mb-3" style="background-color: ${COLORS.accent}">
                  ‚úì Confirm Redemption
                </button>
                
                <button onclick="currentView='employee'; currentCustomer=null; render();" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // Dashboard de admin
      function renderAdmin() {
        return `
          <div class="min-h-screen p-6 bg-gray-100">
            <div class="max-w-6xl mx-auto">
              <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold" style="color: ${COLORS.primary}">Administrator Dashboard</h2>
                  <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                    ‚Üê Logout
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: ${COLORS.secondary}20">
                      <span class="text-2xl">üë•</span>
                    </div>
                    <div>
                      <p class="text-gray-600 text-sm">Total Customers</p>
                      <p class="text-2xl font-bold" style="color: ${COLORS.primary}" id="totalCustomers">-</p>
                    </div>
                  </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: ${COLORS.accent}20">
                      <span class="text-2xl">‚òï</span>
                    </div>
                    <div>
                      <p class="text-gray-600 text-sm">Punches Given</p>
                      <p class="text-2xl font-bold" style="color: ${COLORS.primary}" id="totalPunches">-</p>
                    </div>
                  </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-purple-100">
                      <span class="text-2xl">üéÅ</span>
                    </div>
                    <div>
                      <p class="text-gray-600 text-sm">Rewards Redeemed</p>
                      <p class="text-2xl font-bold" style="color: ${COLORS.primary}" id="totalRewards">-</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold mb-4" style="color: ${COLORS.primary}">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <button onclick="viewAllCustomers()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition">
                    üìã View All Customers
                  </button>
                  <button onclick="exportData()" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition">
                    üìä Export Data
                  </button>
                  <button onclick="changePassword()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition">
                    üîê Change Password
                  </button>
                  <button onclick="viewSettings()" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition">
                    ‚öôÔ∏è Settings
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Funciones de login
      function loginEmployee() {
        isAdmin = false;
        currentView = 'employee';
        render();
      }

      async function loginAdmin() {
        const password = document.getElementById('adminPassword').value;
        const settings = await window.supabaseAPI.getSettings();
        
        if (password === settings.admin_password) {
          isAdmin = true;
          currentView = 'admin';
          render();
          loadAdminStats();
        } else {
          alert('‚ùå Incorrect password');
        }
      }

      function logout() {
        currentView = 'login';
        isAdmin = false;
        currentCustomer = null;
        stopQRScanner();
        render();
      }

      // Funciones de escaneo QR
      function startQRScanner() {
        if (html5QrCode) {
          stopQRScanner();
        }

        html5QrCode = new Html5Qrcode("qr-reader");
        
        html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText) => {
            stopQRScanner();
            await handleScannedQR(decodedText);
          }
        ).catch(err => {
          console.error("Camera error:", err);
          alert("‚ùå Cannot access camera. Please allow camera permissions.");
          currentView = 'employee';
          render();
        });
      }

      function stopQRScanner() {
        if (html5QrCode) {
          html5QrCode.stop().then(() => {
            html5QrCode.clear();
            html5QrCode = null;
          }).catch(err => {
            console.error("Error stopping scanner:", err);
          });
        }
      }

      async function handleScannedQR(qrCode) {
        const customer = await window.supabaseAPI.getCustomerByQR(qrCode);
        
        if (!customer) {
          alert('‚ùå Customer not found');
          currentView = 'employee';
          render();
          return;
        }

        currentCustomer = customer;

        if (customer.punches >= 10 && customer.reward_code) {
          currentView = 'validateReward';
        } else {
          currentView = 'givePunch';
        }
        render();
      }

      async function givePunch() {
        const c = currentCustomer;
        const newPunches = c.punches + 1;
        let rewardCode = c.reward_code;

        if (newPunches >= 10 && !rewardCode) {
          rewardCode = generateRewardCode();
        }

        await window.supabaseAPI.updateCustomer(c.id, {
          punches: newPunches,
          reward_code: rewardCode,
          last_visit: new Date().toISOString()
        });

        await window.supabaseAPI.addPunch(c.id, c.punches, newPunches);

        if (newPunches >= 10 && rewardCode) {
          alert(`üéâ ${c.name} completed 10 punches!\n\nReward code: ${rewardCode}\n\nUse in TOAST POS for free drink.`);
        } else {
          alert(`‚úÖ Punch added!\n\n${c.name} now has ${newPunches}/10 punches.`);
        }

        currentView = 'employee';
        currentCustomer = null;
        render();
      }

      async function confirmRedemption() {
        const c = currentCustomer;
        
        await window.supabaseAPI.updateCustomer(c.id, {
          punches: 0,
          reward_code: null,
          rewards_redeemed: c.rewards_redeemed + 1,
          last_visit: new Date().toISOString()
        });
        
        await window.supabaseAPI.redeemReward(c.id, c.reward_code);
        
        alert(`‚úÖ Reward redeemed!\n\nCode "${c.reward_code}" used in TOAST\n\n${c.name}'s card reset to 0/10`);
        
        currentView = 'employee';
        currentCustomer = null;
        render();
      }

      function generateRewardCode() {
        const codes = ['COFFEE','ESPRES','LATTE1','MOCHA1','BEANS1','ORIGIN','SMOOTH','STRONG','SWEET1','CREAM1'];
        return codes[Math.floor(Math.random() * codes.length)];
      }

      async function viewCustomers() {
        const customers = await window.supabaseAPI.getCustomers();
        let message = `üìã CUSTOMERS (${customers.length}):\n\n`;
        customers.slice(0, 10).forEach(c => {
          message += `${c.name}\n${c.phone} | ${c.punches}/10 punches\n\n`;
        });
        alert(message);
      }

      async function loadAdminStats() {
        const customers = await window.supabaseAPI.getCustomers();
        const punches = await window.supabaseAPI.getAllPunches();
        const rewards = await window.supabaseAPI.getAllRewards();

        document.getElementById('totalCustomers').textContent = customers.length;
        document.getElementById('totalPunches').textContent = punches.length;
        document.getElementById('totalRewards').textContent = rewards.length;
      }

      async function viewAllCustomers() {
        const customers = await window.supabaseAPI.getCustomers();
        let message = `üìã ALL CUSTOMERS (${customers.length}):\n\n`;
        customers.forEach((c, i) => {
          message += `${i+1}. ${c.name}\n   üìû ${c.phone}\n   ‚òï ${c.punches}/10 punches\n   üéÅ ${c.rewards_redeemed} rewards\n\n`;
        });
        alert(message);
      }

      async function exportData() {
        alert('üìä Export feature coming soon!\n\nYou can access your data directly in Supabase dashboard.');
      }

      async function changePassword() {
        const newPassword = prompt('Enter new administrator password:');
        if (newPassword && newPassword.length >= 6) {
          await window.supabaseAPI.updateSettings('admin_password', newPassword);
          alert('‚úÖ Password changed successfully!');
        } else {
          alert('‚ùå Password must be at least 6 characters');
        }
      }

      async function viewSettings() {
        const settings = await window.supabaseAPI.getSettings();
        let message = `‚öôÔ∏è SYSTEM SETTINGS:\n\n`;
        message += `Business: ${settings.business_name}\n`;
        message += `Slogan: ${settings.slogan}\n`;
        message += `Address: ${settings.address}\n`;
        message += `Social: ${settings.social}\n`;
        message += `TOAST Code: ${settings.toast_code}\n`;
        alert(message);
      }

      // Inicializar
      window.onload = () => {
        render();
        window.supabaseAPI.testConnection();
      };
    </script>
  </body>
</html>
